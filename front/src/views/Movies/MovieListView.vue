<template>
  <div class="container my-3">
    <div class="page-title mb-5">
      <h1>ì „ì²´ ì˜í™” ì¡°íšŒ</h1>
    </div>
    <div class="movie-list-container">
      <!-- êµ­ê°€, ì¥ë¥´ ì¤‘ë³µì²´í¬ ê°€ëŠ¥ -->
      <div class="select-option-form">
        <!-- êµ­ê°€ ì„ íƒ -->
        <div class="select-country">
          <h4>êµ­ê°€ ì„ íƒ</h4>

          <!-- ë¯¸êµ­ -->
          <input
            type="checkbox"
            class="btn-check"
            id="ctr1"
            value="1"
            v-model="checkedCountry"
          />
          <label for="ctr1" class="btn">ë¯¸êµ­</label>
          <!-- í•œêµ­ -->
          <input
            type="checkbox"
            class="btn-check"
            id="ctr2"
            value="2"
            v-model="checkedCountry"
          />
          <label for="ctr2" class="btn">í•œêµ­</label>
          <!-- ì˜êµ­ -->
          <input
            type="checkbox"
            class="btn-check"
            id="ctr3"
            value="3"
            v-model="checkedCountry"
          />
          <label for="ctr3" class="btn">ì˜êµ­</label>
          <!-- ì¼ë³¸ -->
          <input
            type="checkbox"
            class="btn-check"
            id="ctr4"
            value="4"
            v-model="checkedCountry"
          />
          <label for="ctr4" class="btn">ì¼ë³¸</label>
          <!-- ì¤‘êµ­ -->
          <input
            type="checkbox"
            class="btn-check"
            id="ctr5"
            value="5"
            v-model="checkedCountry"
          />
          <label for="ctr5" class="btn">ì¤‘êµ­</label>
          <!-- í”„ë‘ìŠ¤ -->
          <input
            type="checkbox"
            class="btn-check"
            id="ctr6"
            value="6"
            v-model="checkedCountry"
          />
          <label for="ctr6" class="btn">í”„ë‘ìŠ¤</label>
          <!-- ê¸°íƒ€ êµ­ê°€ -->
          <input
            type="checkbox"
            class="btn-check"
            id="ctr7"
            value="7"
            v-model="checkedCountry"
          />
          <label for="ctr7" class="btn">ê¸°íƒ€ êµ­ê°€</label>
        </div>
        <!-- ì¥ë¥´ ì„ íƒ -->
        <div class="select-genre">
          <h4>ì¥ë¥´ ì„ íƒ</h4>
          <!-- ëª¨í—˜, íŒíƒ€ì§€ -->
          <input
            type="checkbox"
            class="btn-check"
            id="gen1"
            value="12, 14"
            @change="handleGenreChange($event)"
          />
          <label for="gen1" class="btn">ğŸ‡ëª¨í—˜, íŒíƒ€ì§€ ğŸ†</label>
          <!-- ë¡œë§¨ìŠ¤-->
          <input
            type="checkbox"
            class="btn-check"
            id="gen2"
            value="10749"
            @change="handleGenreChange($event)"
          />
          <label for="gen2" class="btn">ğŸ’–ë¡œë§¨ìŠ¤ğŸ’</label>
          <input
            type="checkbox"
            class="btn-check"
            id="gen3"
            value="18, 35"
            @change="handleGenreChange($event)"
          />
          <label for="gen3" class="btn">ğŸ¤—ë“œë¼ë§ˆ, ì½”ë¯¸ë””ğŸ¤£</label>

          <!-- ì• ë‹ˆë©”ì´ì…˜, TV ì˜í™”  -->
          <input
            type="checkbox"
            class="btn-check"
            id="gen4"
            value="16, 10770"
            @change="handleGenreChange($event)"
          />
          <label for="gen4" class="btn">ğŸ§â€â™‚ï¸ì• ë‹ˆ, tvğŸ“º</label>

          <!-- ìŒì•…, ê°€ì¡± -->
          <input
            type="checkbox"
            class="btn-check"
            id="gen5"
            value="10402, 10751"
            @change="handleGenreChange($event)"
          />
          <label for="gen5" class="btn">ğŸµìŒì•…, ê°€ì¡±ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</label>
          <!-- ê³µí¬, ìŠ¤ë¦´ëŸ¬-->
          <input
            type="checkbox"
            class="btn-check"
            id="gen6"
            value="27, 53"
            @change="handleGenreChange($event)"
          />
          <label for="gen6" class="btn">ğŸ˜±ê³µí¬, ìŠ¤ë¦´ëŸ¬ğŸ§›â€â™€ï¸</label>
          <!-- SF, ë¯¸ìŠ¤í„°ë¦¬ -->
          <input
            type="checkbox"
            class="btn-check"
            id="gen7"
            value="878, 9648"
            @change="handleGenreChange($event)"
          />
          <label for="gen7" class="btn">ğŸ‘¨â€ğŸš€SF, ë¯¸ìŠ¤í„°ë¦¬ğŸ˜²</label>

          <!-- ì•¡ì…˜, ë²”ì£„ -->
          <input
            type="checkbox"
            class="btn-check"
            id="gen8"
            value="28, 80"
            @change="handleGenreChange($event)"
          />
          <label for="gen8" class="btn">ğŸƒâ€â™€ï¸ì•¡ì…˜, ë²”ì£„ğŸ‘®â€â™‚ï¸</label>
          <!-- ì—­ì‚¬, ë‹¤íë©˜í„°ë¦¬ -->
          <input
            type="checkbox"
            class="btn-check"
            id="gen9"
            value="36, 99"
            @change="handleGenreChange($event)"
          />
          <label for="gen9" class="btn">ğŸ’«ì—­ì‚¬, ë‹¤íë©˜í„°ë¦¬ğŸ“š</label>
          <!-- ì„œë¶€, ì „ìŸ -->
          <input
            type="checkbox"
            class="btn-check"
            id="gen10"
            value="37, 10752"
            @change="handleGenreChange($event)"
          />
          <label for="gen10" class="btn">ğŸ¤ ì„œë¶€, ì „ìŸğŸ¹</label>
        </div>
        <!-- ì •ë ¬ ê¸°ì¤€ ì„ íƒ -->
        <div class="select-criteria d-flex flex-row justify-content-end">
          <!-- <label for="sort">ì •ë ¬ ê¸°ì¤€</label><br /> -->
          <select class="selectBox mx-2" v-model="sortOption">
            <option value="recent">ìµœì‹ </option>
            <option value="review">ë¦¬ë·°</option>
            <option value="like">ì¢‹ì•„ìš”</option>
            <option value="popularity">ì¸ê¸°</option>
          </select>
          <div class="select-movies">
            <button class="listBtn mx-2" @click="loadMovies">ì˜í™” ì¡°íšŒ</button>
          </div>
        </div>
      </div>
      <div class="row movie-list mt-4 d-flex justify-content-center">
        <MovieCard
          v-for="movie in movieList"
          :key="movie.id"
          :movie="movie"
          class="movieCard col-12 col-sm-6 col-md-4 col-lg-3 mb-4"
        />
      </div>
      <Pagination
        class="d-flex justify-content-center"
        :current-page="currentPage"
        :total-pages="totalPages"
        :page-group="pageGroup"
        :group-size="groupSize"
        @page-changed="handlePageChange"
      />
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, watch } from "vue";
import { useAccountStore } from "@/stores/accounts";
import axios from "axios";
import qs from "qs";
import MovieCard from "@/components/Movies/MovieCard.vue";
import Pagination from "@/components/Pagination.vue";

const store = useAccountStore();
const checkedCountry = ref([]);
const checkedGenre = ref([]);
const sortOption = ref("recent"); // ê¸°ë³¸ ì •ë ¬ ê¸°ì¤€

// í˜ì´ì§€ ë„¤ì´ì…˜ ê´€ë ¨ ===================================
const currentPage = ref(1);
const totalPages = ref(1);
const pageGroup = ref(1);
const groupSize = ref(7);

// ì¥ë¥´ ë³€ê²½ í•¸ë“¤ëŸ¬
const handleGenreChange = (event) => {
  const genreValues = event.target.value.split(","); // ì—¬ëŸ¬ ê°’ì„ ì‰¼í‘œë¡œ ë¶„ë¦¬
  if (event.target.checked) {
    // ì²´í¬ëœ ê²½ìš° ë°°ì—´ì— ì¶”ê°€
    checkedGenre.value.push(...genreValues.map((value) => value.trim())); // ê³µë°± ì œê±°
  } else {
    // ì²´í¬ í•´ì œëœ ê²½ìš° ë°°ì—´ì—ì„œ ì œê±°
    checkedGenre.value = checkedGenre.value.filter(
      (item) => !genreValues.some((value) => value.trim() === item)
    );
  }
};

const movieList = ref([]);
const loadMovies = (page = 1) => {
  const params = {
    country: checkedCountry.value,
    genre: checkedGenre.value,
    sort: sortOption.value,
    page,
  };
  console.log(params);

  axios({
    method: "get",
    url: `${store.API_URL}/api/v1/movies`,
    params,
    paramsSerializer: (params) => {
      return qs.stringify(params, { arrayFormat: "repeat" });
    },
  })
    .then((res) => {
      console.log(res.data);
      movieList.value = res.data.results;
      totalPages.value = Math.ceil(res.data.count / 20);
      pageGroup.value = Math.ceil(currentPage.value / groupSize.value);
    })
    .catch((err) => {
      console.log(err);
    });
};

// í˜ì´ì§€ ë³€ê²½ í•¸ë“¤ëŸ¬
const handlePageChange = (page) => {
  if (typeof page === "number") {
    currentPage.value = page;
    loadMovies(page);
  }
};

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ì˜µì…˜ìœ¼ë¡œ í˜¸ì¶œ ê°€ëŠ¥)
onMounted(() => {
  loadMovies();
});

// í˜ì´ì§€ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜ì´ì§ ê·¸ë£¹ ê°±ì‹ 
watch(currentPage, () => {
  pageGroup.value = Math.ceil(currentPage.value / groupSize.value);
});
</script>

<style scoped>
.btn {
  margin-right: 10px;
  margin-bottom: 10px;
  border: 2px solid transparent;
  transition: border-color 0.3s;
}

.btn:last-child {
  margin-right: 0;
}
.btn-check:checked + label {
  border-color: #d2de32;
}
.listBtn {
  background-color: #febbcc;
  border: 2px solid #ffcccc;
  border-radius: 5px;
  font-size: 18px;
}
.selectBox {
  border: none;
  border-radius: 5px;

  width: 12%;
}
.selectBox:focus {
  border: #e6a4b4;
}
</style>
